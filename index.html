<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>網頁名單勾選</title>
    
    <!-- PWA 行動裝置軟體化設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="勾選系統">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/281/281760.png">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuaZuumen+W9memxuOezu+e1fSIsCiAgInNob3J0X25hbWUiIjogIuW9memxuQXBwIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZheZmIiwKICAidGhlbWVfY29sb3IiIjogIiMyNTYzZWIiCn0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .filter-content { max-height: 200px; overflow-y: auto; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <!-- 自定義提示視窗 (Modal) -->
    <div id="systemModal" class="fixed inset-0 z-[200] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full fade-in text-center">
            <div id="modalIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"></div>
            <h3 id="modalTitle" class="text-xl font-bold text-slate-800 mb-2"></h3>
            <p id="modalMsg" class="text-slate-500 mb-6 text-sm"></p>
            <button onclick="closeModal()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all active:scale-95">確定</button>
        </div>
    </div>

    <!-- 登入與註冊介面 -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full fade-in">
            <div id="loginBox">
                <div class="text-center mb-6">
                    <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i data-lucide="shield-check" class="text-white w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">勾選系統登入</h2>
                </div>
                <div class="space-y-4">
                    <input type="text" id="userAccount" placeholder="帳號" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="password" id="userPwd" placeholder="密碼" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <button onclick="authAction('login')" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all disabled:bg-slate-400 active:scale-95">登入系統</button>
                    <p class="text-center text-sm text-slate-500">還沒有帳號？ <button onclick="toggleAuth(true)" class="text-blue-600 font-bold">立即註冊</button></p>
                </div>
            </div>

            <div id="registerBox" class="hidden">
                <div class="text-center mb-6">
                    <div class="bg-emerald-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i data-lucide="user-plus" class="text-white w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">註冊帳號</h2>
                </div>
                <div class="space-y-4">
                    <input type="text" id="regRealName" placeholder="您的真實姓名" class="w-full px-4 py-3 bg-slate-50 border rounded-xl">
                    <input type="text" id="regAccount" placeholder="註冊帳號" class="w-full px-4 py-3 bg-slate-50 border rounded-xl">
                    <input type="password" id="regPwd" placeholder="設定密碼" class="w-full px-4 py-3 bg-slate-50 border rounded-xl">
                    <button onclick="authAction('register')" id="regBtn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition-all disabled:bg-slate-400">確認註冊</button>
                    <p class="text-center text-sm text-slate-500"><button onclick="toggleAuth(false)" class="text-emerald-600 font-bold">返回登入</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主程式內容 -->
    <div id="mainApp" class="max-w-6xl mx-auto py-8 px-4 blur-md transition-all">
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 flex justify-between items-center border border-slate-200">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="database" class="text-blue-600"></i>智慧篩選系統</h1>
            <div class="flex items-center gap-3">
                <span id="displayUserName" class="text-sm font-bold text-blue-700 bg-blue-50 px-3 py-1 rounded-full">未登入</span>
                <button onclick="location.reload()" class="text-slate-300 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden sticky top-6">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <span class="text-sm font-bold">篩選面板</span>
                        <button onclick="resetFilters()" class="text-xs text-blue-600 hover:underline">重設</button>
                    </div>
                    <div id="filterAccordion" class="divide-y divide-slate-100 max-h-[70vh] overflow-y-auto no-scrollbar"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-4">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-[600px] flex flex-col overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-white">
                        <div class="flex items-center gap-4">
                            <span id="matchCount" class="text-xs font-bold text-blue-600 uppercase tracking-widest">0 項符合</span>
                        </div>
                        <button onclick="fetchData()" id="refreshBtn" class="text-slate-400 hover:text-blue-600 transition-colors active:rotate-180 duration-500">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="itemList" class="flex-1 overflow-y-auto divide-y divide-slate-50 bg-slate-50/30">
                        <div class="p-10 text-center text-slate-400 text-sm flex flex-col items-center gap-3">正在載入試算表資料...</div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4">
                    <input type="password" id="docPassword" placeholder="輸入文件密碼" class="flex-1 px-4 py-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <button onclick="submitData()" id="submitBtn" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2 disabled:bg-slate-400 active:scale-95">
                        <i data-lucide="send" class="w-5 h-5"></i>確認勾選匯出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby_A5Kik4N2D50HBV8lCI49FyqIwqJ6lqzPyI2w2zjx0fpkjD9e4d7BiK-7aZ0eMbf3/exec";
        
        const DOC_MAP = { 
            "111": "1tjLPdvchNV3gBB4oEXTQxo-DidvztFxmsgaxP4fqQmg",
            "222": "1-brdXTq8205d4fRETIIhyIFOdfcVnOdfZz5KpFzd3oI",
            "333": "14cyDbD782VBtYbtwq7zYNguDqe8HUVbCMDTY24KyXGo",
            "444": "1Nv-uPF00pKcj53xcwEzAzlY5Bj0g1xSFbeQBmLMBLkk",
            "555": "1wTqhH4ApfilybEF0PK_DVfXzqKis0RD4uue_4c2_m6o"
        };
        
        let rawHeaders = [], allDataRows = [], selectedFilters = {}, currentUserRealName = "";

        const targetSpecs = [
            { letter: 'A', idx: 0 },
            { letter: 'B', idx: 1 },
            { letter: 'D', idx: 3 },
            { letter: 'U', idx: -1, isVirtual: true, customLabel: '單位' },
            { letter: 'S', idx: 18 },
            { letter: 'T', idx: 19 },
            { letter: 'U', idx: 20 },
            { letter: 'V', idx: 21 }
        ];

        lucide.createIcons();

        function extractUnitFromS(sVal) {
            const str = String(sVal || "");
            const match = str.match(/^[^0-9]+/);
            return match ? match[0].trim() : "未定義";
        }

        function showModal(title, msg, type = 'success') {
            const modal = document.getElementById('systemModal');
            const iconBox = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const msgEl = document.getElementById('modalMsg');

            titleEl.innerText = title;
            msgEl.innerText = msg;

            if (type === 'success') {
                iconBox.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-emerald-100 text-emerald-600";
                iconBox.innerHTML = '<i data-lucide="check-circle" class="w-10 h-10"></i>';
            } else {
                iconBox.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-100 text-red-600";
                iconBox.innerHTML = '<i data-lucide="alert-circle" class="w-10 h-10"></i>';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('systemModal').classList.add('hidden');
        }

        function toggleAuth(showReg) {
            document.getElementById('loginBox').classList.toggle('hidden', showReg);
            document.getElementById('registerBox').classList.toggle('hidden', !showReg);
        }

        async function postToGAS(data) {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                mode: 'cors'
            });
            return await response.json();
        }

        async function authAction(type) {
            const btn = type === 'login' ? document.getElementById('loginBtn') : document.getElementById('regBtn');
            const originalText = btn.innerText;
            
            let payload = { action: type };
            if (type === 'login') {
                payload.username = document.getElementById('userAccount').value.trim();
                payload.password = document.getElementById('userPwd').value.trim();
                if (!payload.username || !payload.password) return showModal("提醒", "請填寫帳號密碼", "error");
            } else {
                payload.realName = document.getElementById('regRealName').value.trim();
                payload.username = document.getElementById('regAccount').value.trim();
                payload.password = document.getElementById('regPwd').value.trim();
                if (!payload.realName || !payload.username || !payload.password) return showModal("提醒", "請填寫完整資訊", "error");
            }

            btn.disabled = true;
            btn.innerText = "連線中...";

            try {
                const result = await postToGAS(payload);
                if (result.success) {
                    if (type === 'login') {
                        currentUserRealName = result.realName;
                        document.getElementById('displayUserName').innerText = currentUserRealName;
                        document.getElementById('loginOverlay').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('blur-md');
                        fetchData();
                    } else {
                        showModal("註冊成功", "帳號已建立，現在請進行登入");
                        toggleAuth(false);
                    }
                } else {
                    showModal("操作失敗", result.message || "帳號可能已存在", "error");
                }
            } catch (e) {
                console.error(e);
                showModal("連線失敗", "無法連接到伺服器", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function fetchData() {
            const listDiv = document.getElementById('itemList');
            listDiv.innerHTML = '<div class="p-10 text-center text-slate-400 text-sm flex flex-col items-center gap-3"><div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>讀取雲端資料中...</div>';
            
            try {
                const res = await fetch(API_URL);
                const result = await res.json();
                
                rawHeaders = (result.headers || []).map(h => String(h).trim());
                allDataRows = result.rows || [];
                
                createFilterUI();
                applyFilters();
            } catch (e) { 
                console.error("Fetch Error", e);
                listDiv.innerHTML = '<div class="p-10 text-center text-red-400 text-sm">載入失敗</div>';
            }
        }

        function createFilterUI() {
            const container = document.getElementById('filterAccordion');
            container.innerHTML = '';
            selectedFilters = {};

            const sheetNames = [...new Set(allDataRows.map(r => r['_來源分頁'] || "未知"))].filter(s => s).sort();
            if (sheetNames.length > 0) {
                const sheetHeader = "工作表名稱";
                selectedFilters[sheetHeader] = [];
                renderFilterGroup(container, sheetHeader, sheetNames, { letter: '★', isSystem: true });
            }

            targetSpecs.forEach(spec => {
                let label = "";
                let options = [];

                if (spec.isVirtual && spec.customLabel === "單位") {
                    label = "單位";
                    const sHeader = rawHeaders[18];
                    options = [...new Set(allDataRows.map(r => extractUnitFromS(r[sHeader])))].filter(s => s !== "").sort();
                } else {
                    const headerName = rawHeaders[spec.idx];
                    if (!headerName || headerName === "") return;
                    label = headerName;
                    options = [...new Set(allDataRows.map(r => {
                        const val = r[headerName];
                        return (val !== undefined && val !== null) ? String(val).trim() : "";
                    }))].filter(s => s !== "").sort();
                }
                
                if(options.length === 0) return;
                selectedFilters[label] = [];
                renderFilterGroup(container, label, options, spec);
            });
            lucide.createIcons();
        }

        function renderFilterGroup(container, headerName, options, spec) {
            const group = document.createElement('div');
            group.className = "group-filter border-b border-slate-50 last:border-0";
            
            const tagClass = spec.isSystem 
                ? "bg-amber-500 text-white" 
                : "bg-blue-600 text-white";

            group.innerHTML = `
                <button class="w-full p-4 flex justify-between items-center text-xs font-bold text-slate-600 hover:bg-slate-50/50 transition-colors" onclick="toggleAccordion(this)">
                    <span class="flex items-center gap-2">
                        <span class="${tagClass} w-4 h-4 flex items-center justify-center rounded-[4px] text-[8px] uppercase font-black shadow-sm">${spec.letter}</span>
                        ${headerName}
                    </span>
                    <i data-lucide="chevron-down" class="w-3 h-3 transition-transform duration-200"></i>
                </button>
                <div class="hidden px-4 pb-4 space-y-1 filter-content no-scrollbar">
                    ${options.map(opt => `
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded-lg transition-all group">
                            <input type="checkbox" onchange="updateFilter('${headerName}', '${opt}', this.checked)" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-[11px] text-slate-500 group-hover:text-slate-800">${opt}</span>
                        </label>`).join('')}
                </div>`;
            container.appendChild(group);
        }

        function toggleAccordion(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('svg');
            if (content) {
                const isHidden = content.classList.contains('hidden');
                content.classList.toggle('hidden');
                if (icon) icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        function updateFilter(h, v, checked) {
            if (checked) {
                if (!selectedFilters[h]) selectedFilters[h] = [];
                selectedFilters[h].push(v);
            } else {
                selectedFilters[h] = selectedFilters[h].filter(i => i !== v);
            }
            applyFilters();
        }

        function applyFilters() {
            const filtered = allDataRows.filter(row => {
                for (let h in selectedFilters) {
                    if (selectedFilters[h] && selectedFilters[h].length > 0) {
                        if (h === "工作表名稱") {
                            if (!selectedFilters[h].includes(row['_來源分頁'] || "未知")) return false;
                        } else if (h === "單位") {
                            const sHeader = rawHeaders[18];
                            const extracted = extractUnitFromS(row[sHeader]);
                            if (!selectedFilters[h].includes(extracted)) return false;
                        } else {
                            const cellVal = (row[h] !== undefined && row[h] !== null) ? String(row[h]).trim() : "";
                            if (!selectedFilters[h].includes(cellVal)) return false;
                        }
                    }
                }
                return true;
            });
            renderList(filtered);
        }

        function renderList(data) {
            const listDiv = document.getElementById('itemList');
            document.getElementById('matchCount').innerText = `${data.length} 項符合`;
            
            if (data.length === 0) {
                listDiv.innerHTML = '<div class="p-20 text-center text-slate-400 text-sm italic">目前沒有符合條件的資料</div>';
                return;
            }

            listDiv.innerHTML = data.map((row, idx) => {
                const sHeader = rawHeaders[18];
                const extractedUnit = extractUnitFromS(row[sHeader]);

                const displayContent = targetSpecs.map(spec => {
                    let label = "";
                    let val = "";
                    
                    if (spec.isVirtual && spec.customLabel === "單位") {
                        label = "單位";
                        val = extractedUnit;
                    } else {
                        const headerName = rawHeaders[spec.idx] || `欄位 ${spec.letter}`;
                        label = headerName;
                        val = row[headerName];
                    }

                    return `<div class="flex flex-col min-w-[70px] flex-1">
                                <span class="text-[10px] text-blue-500 font-bold mb-1 border-b border-blue-100/30 truncate uppercase">${label}</span>
                                <span class="text-[13px] text-slate-700 font-semibold break-words leading-tight">${(val !== undefined && val !== "") ? val : "-"}</span>
                            </div>`;
                }).join('');

                const valA = row[rawHeaders[1]] || ""; 
                let valB = row[rawHeaders[0]] || "";   
                const valD = row[rawHeaders[3]] || ""; 
                const valS = row[rawHeaders[18]] || ""; 

                if (valB && !isNaN(valB)) valB = String(Number(valB));
                const exportVal = `${valA} ${valB} ${valD}｜（${valS}）`.trim();
                
                return `
                <label class="flex items-start p-5 hover:bg-white cursor-pointer transition-all border-b border-slate-100 group relative">
                    <input type="checkbox" name="item" data-export-val="${exportVal}" class="w-6 h-6 mt-3 rounded-md border-slate-300 text-blue-600 focus:ring-blue-500 shrink-0 shadow-sm">
                    <div class="ml-5 flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] text-slate-400 font-medium flex items-center gap-1">
                                <i data-lucide="hash" class="w-3 h-3"></i> 行號 #${idx + 2} <span class="mx-1 text-slate-200">|</span> <span class="text-amber-600 font-bold">${row['_來源分頁'] || 'Sheet'}</span>
                            </span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-x-6 gap-y-4">
                            ${displayContent}
                        </div>
                    </div>
                </label>`;
            }).join('');
            
            lucide.createIcons();
        }

        async function submitData() {
            const pwd = document.getElementById('docPassword').value.trim();
            const checked = document.querySelectorAll('input[name="item"]:checked');
            
            if (checked.length === 0) return showModal("提醒", "請至少選擇一項資料", "error");
            
            const targetDocId = DOC_MAP[pwd];
            if (!targetDocId) return showModal("錯誤", "文件密碼不正確，無法匯出", "error");
            
            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerText = "傳送中...";

            try {
                const payload = {
                    action: 'export',
                    items: Array.from(checked).map(i => i.getAttribute('data-export-val')),
                    docId: pwd,
                    targetDocId: targetDocId,
                    sender: currentUserRealName || "使用者"
                };

                const res = await postToGAS(payload);
                if (res.success) {
                    showModal("發送成功", `已成功將 ${checked.length} 筆資料匯出至雲端！`);
                    checked.forEach(c => c.checked = false);
                    document.getElementById('docPassword').value = '';
                } else { 
                    showModal("匯出失敗", res.message, "error"); 
                }
            } catch (e) { 
                showModal("錯誤", "伺服器連線失敗", "error"); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        function resetFilters() {
            document.querySelectorAll('#filterAccordion input[type="checkbox"]').forEach(c => c.checked = false);
            for(let h in selectedFilters) selectedFilters[h] = [];
            applyFilters();
        }
    </script>
</body>
</html>
